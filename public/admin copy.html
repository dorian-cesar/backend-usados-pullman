<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Usados Pullman 2026</title>

    <!-- ✅ Bootstrap 5.3 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- ✅ SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      :root {
        --primary-color: #003366;
      }
      .navbar {
        background-color: var(--primary-color) !important;
      }
      .hidden {
        display: none !important;
      }
      .card-header {
        background-color: #f8f9fa;
        font-weight: bold;
      }
      body {
        background-color: #f4f7f6;
      }
    </style>
  </head>
  <body class="bg-light">
    <!-- SECCIÓN LOGIN -->
    <div id="login-section" class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-4">
          <div class="card shadow">
            <div class="card-body">
              <h3 class="text-center mb-4">Admin Login</h3>
              <form id="login-form">
                <div class="mb-3">
                  <label>Email</label>
                  <input
                    type="email"
                    id="login-email"
                    class="form-control"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label>Contraseña</label>
                  <input
                    type="password"
                    id="login-pass"
                    class="form-control"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-primary w-100">
                  Ingresar
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SECCIÓN DASHBOARD -->
    <div id="admin-section" class="hidden">
      <nav class="navbar navbar-dark mb-4">
        <div class="container">
          <a class="navbar-brand" href="#">Panel Usados Pullman 2026</a>
          <button class="btn btn-outline-light btn-sm" onclick="logout()">
            Cerrar Sesión
          </button>
        </div>
      </nav>

      <div class="container">
        <div class="row">
          <!-- Categorías -->
          <div class="col-md-4">
            <div class="card shadow-sm mb-4">
              <div class="card-header">Nueva Categoría</div>
              <div class="card-body">
                <div class="input-group">
                  <input
                    id="cat-name"
                    class="form-control"
                    placeholder="Ej: Buses"
                  />
                  <button class="btn btn-success" onclick="createCategory()">
                    Añadir
                  </button>
                </div>
                <ul id="cat-list" class="list-group mt-3 small"></ul>
              </div>
            </div>
          </div>

          <!-- Productos -->
          <div class="col-md-8">
            <div class="card shadow-sm mb-4">
              <div class="card-header">Registrar Producto</div>
              <div class="card-body">
                <form id="prod-form" class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Título</label>
                    <input id="p-title" class="form-control" required />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Precio</label>
                    <input id="p-price" type="number" class="form-control" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Categoría</label>
                    <select id="p-category" class="form-select"></select>
                  </div>
                  <div class="col-12">
                    <label class="form-label">URL Imagen</label>
                    <input id="p-image" class="form-control" />
                  </div>
                  <div class="col-12">
                    <button class="btn btn-primary">Guardar Producto</button>
                  </div>
                </form>
              </div>
            </div>

            <div class="table-responsive bg-white p-3 shadow-sm rounded">
              <h5>Inventario</h5>
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>Título</th>
                    <th>Categoría</th>
                    <th>Precio</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="prod-table"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ Bootstrap JS (opcional pero recomendado) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const API_URL = "/api";
      let token = localStorage.getItem("token");

      // --- MANEJO DE VISTAS ---
      function checkAuth() {
        if (token) {
          document.getElementById("login-section").classList.add("hidden");
          document.getElementById("admin-section").classList.remove("hidden");
          loadData();
        }
      }

      function logout() {
        localStorage.removeItem("token");
        location.reload();
      }

      // --- LOGIN ---
      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = document.getElementById("login-email").value;
          const password = document.getElementById("login-pass").value;

          const res = await fetch(`${API_URL}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          const data = await res.json();
          if (res.ok) {
            localStorage.setItem("token", data.token);
            location.reload();
          } else {
            Swal.fire("Error", "Credenciales inválidas", "error");
          }
        });

      // --- CARGAR DATOS ---
      async function loadData() {
        // Cargar Categorías
        const resCat = await fetch(`${API_URL}/categories`);
        const cats = await resCat.json();
        const catSelect = document.getElementById("p-category");
        const catList = document.getElementById("cat-list");

        catSelect.innerHTML = "";
        catList.innerHTML = "";
        cats.forEach((c) => {
          catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
          catList.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${c.name} <button class="btn btn-sm btn-danger" onclick="deleteCategory(${c.id})">×</button>
                </li>`;
        });

        // Cargar Productos
        const resProd = await fetch(`${API_URL}/products`);
        const prods = await resProd.json();
        const prodTable = document.getElementById("prod-table");
        prodTable.innerHTML = "";
        prods.forEach((p) => {
          prodTable.innerHTML += `
                    <tr>
                        <td>${p.plate}</td>
                        <td><span class="badge bg-info text-dark">${p.category?.name || "N/A"}</span></td>
                        <td>$${p.price.toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})">Borrar</button>
                        </td>
                    </tr>
                `;
        });
      }

      // --- ACCIONES API ---
      async function createCategory() {
        const name = document.getElementById("cat-name").value;
        await fetch(`${API_URL}/categories`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ name, slug: name.toLowerCase() }),
        });
        loadData();
      }

      document
        .getElementById("prod-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const product = {
            title: document.getElementById("p-title").value,
            price: document.getElementById("p-price").value,
            categoryId: document.getElementById("p-category").value,
            image: document.getElementById("p-image").value,
          };

          await fetch(`${API_URL}/products`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(product),
          });
          Swal.fire("Éxito", "Producto guardado", "success");
          loadData();
          e.target.reset();
        });

      async function deleteProduct(id) {
        if (!confirm("¿Seguro?")) return;
        await fetch(`${API_URL}/products/${id}`, {
          method: "DELETE",
          headers: { Authorization: `Bearer ${token}` },
        });
        loadData();
      }

      checkAuth();
    </script>
  </body>
</html>
