<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Usados Pullman 2026</title>

    <!-- ‚úÖ Bootstrap 5.3 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- ‚úÖ SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      :root {
        --pullman-blue: #003366;
        --pullman-gold: #ffcc00;
      }
      body {
        background-color: #f0f2f5;
        font-family: "Segoe UI", sans-serif;
      }
      .navbar {
        background-color: var(--pullman-blue) !important;
        border-bottom: 3px solid var(--pullman-gold);
      }
      .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      .section-title {
        font-size: 0.75rem;
        font-weight: 800;
        text-transform: uppercase;
        color: #888;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        margin-bottom: 15px;
        margin-top: 10px;
      }
      .hidden {
        display: none !important;
      }
      .form-label {
        font-weight: 600;
        font-size: 0.85rem;
      }
      .sticky-form {
        position: sticky;
        top: 80px;
      }
    </style>
  </head>
  <body>
    <!-- LOGIN -->
    <div id="login-section" class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-4">
          <div class="card p-4 shadow">
            <h4 class="text-center mb-4">Gesti√≥n Pullman</h4>
            <form id="login-form">
              <div class="mb-3">
                <label class="form-label">Email</label
                ><input
                  type="email"
                  id="login-email"
                  class="form-control"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Password</label
                ><input
                  type="password"
                  id="login-pass"
                  class="form-control"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary w-100">
                Ingresar
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="admin-section" class="hidden">
      <nav class="navbar navbar-dark mb-4 sticky-top">
        <div class="container-fluid px-4">
          <a class="navbar-brand fw-bold" href="#">GESTI√ìN CAT√ÅLOGO USADOS</a>
          <button class="btn btn-sm btn-outline-light" onclick="logout()">
            Cerrar Sesi√≥n
          </button>
        </div>
      </nav>

      <div class="container-fluid px-4">
        <div class="row">
          <!-- COLUMNA IZQUIERDA: CATEGOR√çAS -->
          <div class="col-lg-3">
            <div class="card mb-4">
              <div class="card-header fw-bold">üìÇ Categor√≠as</div>
              <div class="card-body">
                <div class="input-group mb-3">
                  <input
                    type="text"
                    id="cat-name"
                    class="form-control"
                    placeholder="Nueva..."
                  />
                  <button class="btn btn-success" onclick="createCategory()">
                    +
                  </button>
                </div>
                <ul
                  id="cat-list"
                  class="list-group list-group-flush small"
                ></ul>
              </div>
            </div>
          </div>

          <!-- COLUMNA CENTRAL: FORMULARIO VEH√çCULO -->
          <!-- <div class="col-lg-4">
            <div class="card mb-4 sticky-form">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <span id="form-title" class="fw-bold"
                  >üìù Ficha de Veh√≠culo</span
                >
                <button
                  id="btn-cancel-edit"
                  class="btn btn-sm btn-secondary hidden"
                  onclick="resetForm()"
                >
                  Cancelar
                </button>
              </div>
              <div class="card-body">
                <form id="prod-form">
                  <input type="hidden" id="p-id" value="" />
                  <input type="hidden" id="is-editing" value="false" />

                  <div class="section-title">Datos Comerciales</div>
                  <div class="row g-2 mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Patente (PLATE)</label
                      ><input
                        type="text"
                        id="p-PLATE"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Precio ($)</label
                      ><input
                        type="text"
                        id="p-price"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Marca</label
                      ><input type="text" id="p-brand" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Modelo</label
                      ><input type="text" id="p-model" class="form-control" />
                    </div>
                  </div>

                  <div class="section-title">Ficha T√©cnica</div>
                  <div class="row g-2 mb-3">
                    <div class="col-md-4">
                      <label class="form-label">A√±o</label
                      ><input type="number" id="p-year" class="form-control" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">KM</label
                      ><input type="text" id="p-mileage" class="form-control" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Categor√≠a</label
                      ><select id="p-category" class="form-select"></select>
                    </div>
                  </div>

                  <div class="section-title">Multimedia</div>
                  <div class="mb-3">
                    <label class="form-label"
                      >Fotos (Sustituyen a las actuales si subes nuevas)</label
                    >
                    <input
                      type="file"
                      id="p-files"
                      class="form-control"
                      accept="image/*"
                      multiple
                    />
                  </div>

                  <button
                    type="submit"
                    id="btn-submit"
                    class="btn btn-primary w-100 py-2 shadow-sm"
                  >
                    üöÄ Publicar Ahora
                  </button>
                </form>
              </div>
            </div>
          </div> -->
          <div class="col-lg-4">
            <div class="card mb-4 sticky-form">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <span id="form-title" class="fw-bold"
                  >üìù Ficha de Veh√≠culo</span
                >
                <button
                  id="btn-cancel-edit"
                  class="btn btn-sm btn-secondary hidden"
                  onclick="resetForm()"
                >
                  Cancelar
                </button>
              </div>
              <div class="card-body">
                <form id="prod-form">
                  <input type="hidden" id="p-id" value="" />
                  <input type="hidden" id="is-editing" value="false" />

                  <div class="section-title">Datos Comerciales</div>
                  <div class="row g-2 mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Patente (plate)</label>
                      <input
                        type="text"
                        id="p-plate"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Precio ($)</label>
                      <input
                        type="text"
                        id="p-price"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Estado</label>
                      <select id="p-estado" class="form-select">
                        <option value="disponible">‚úÖ Disponible</option>
                        <option value="reservado">‚è≥ Reservado</option>
                        <option value="vendido">üö´ Vendido</option>
                      </select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end px-3">
                      <div class="form-check mb-2">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="p-destacado"
                        />
                        <label
                          class="form-check-label fw-bold"
                          for="p-destacado"
                          >‚≠ê Destacado</label
                        >
                      </div>
                    </div>
                  </div>

                  <div class="section-title">Especificaciones</div>
                  <div class="row g-2 mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Marca</label>
                      <input type="text" id="p-brand" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Modelo</label>
                      <input type="text" id="p-model" class="form-control" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">A√±o</label>
                      <input type="number" id="p-year" class="form-control" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">KM</label>
                      <input type="text" id="p-mileage" class="form-control" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Categor√≠a</label>
                      <select id="p-category" class="form-select"></select>
                    </div>
                  </div>

                  <div class="section-title">Ficha T√©cnica</div>
                  <div class="row g-2 mb-3">
                    <div class="col-md-6">
                      <label class="form-label">Motor</label>
                      <input type="text" id="p-motor" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Chasis</label>
                      <input type="text" id="p-chassis" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Transmisi√≥n</label>
                      <input
                        type="text"
                        id="p-transmission"
                        class="form-control"
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Carrocer√≠a</label>
                      <input type="text" id="p-bodywork" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Ubicaci√≥n</label>
                      <input type="text" id="p-location" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Propiedad</label>
                      <input type="text" id="p-property" class="form-control" />
                    </div>
                  </div>

                  <div class="section-title">Multimedia y Descripci√≥n</div>
                  <div class="mb-3">
                    <label class="form-label">Fotos (M√∫ltiples archivos)</label>
                    <input
                      type="file"
                      id="p-files"
                      class="form-control"
                      accept="image/*"
                      multiple
                    />
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea
                      id="p-description"
                      class="form-control"
                      rows="3"
                    ></textarea>
                  </div>

                  <button
                    type="submit"
                    id="btn-submit"
                    class="btn btn-primary w-100 py-2 shadow-sm"
                  >
                    üöÄ Publicar Ahora
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- COLUMNA DERECHA: LISTADO -->
          <div class="col-lg-5">
            <div class="card">
              <div class="card-header fw-bold">üìä Inventario Activo</div>
              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Patente</th>
                      <th>Veh√≠culo</th>
                      <th>Fotos</th>
                      <th class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="prod-table" class="small"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "/api";
      let token = localStorage.getItem("token");
      let editingId = null;

      function checkAuth() {
        if (token) {
          document.getElementById("login-section").classList.add("hidden");
          document.getElementById("admin-section").classList.remove("hidden");
          loadData();
        }
      }

      function logout() {
        localStorage.removeItem("token");
        location.reload();
      }

      // --- LOGIN ---
      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const res = await fetch(`${API_URL}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: document.getElementById("login-email").value,
              password: document.getElementById("login-pass").value,
            }),
          });
          if (res.ok) {
            const data = await res.json();
            localStorage.setItem("token", data.token);
            location.reload();
          } else {
            Swal.fire("Error", "Credenciales inv√°lidas", "error");
          }
        });

      // --- CARGAR DATOS (PRODUCTOS Y CATEGOR√çAS) ---
      async function loadData() {
        try {
          const [resCat, resProd] = await Promise.all([
            fetch(`${API_URL}/categories`),
            fetch(`${API_URL}/products`),
          ]);
          const cats = await resCat.json();
          const prods = await resProd.json();

          // Render Categor√≠as en Select y en Lista CRUD
          const catSelect = document.getElementById("p-category");
          const catList = document.getElementById("cat-list");
          catSelect.innerHTML = "";
          catList.innerHTML = "";
          cats.forEach((c) => {
            catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            catList.innerHTML += `
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span class="fw-bold">${c.name}</span>
            <div>
                <button class="btn btn-sm text-primary border-0 p-0 me-2" onclick="editCategory(${c.id}, '${c.name}')">‚úèÔ∏è</button>
                <button class="btn btn-sm text-danger border-0 p-0" onclick="deleteCategory(${c.id})">üóëÔ∏è</button>
            </div>
        </li>`;
          });

          // Render Productos con Conteo de Fotos
          const table = document.getElementById("prod-table");
          table.innerHTML = "";
          prods.forEach((p) => {
            const count = p.images ? p.images.length : 0;
            table.innerHTML += `
                        <tr>
                            <td><strong>${p.PLATE || "S/P"}</strong></td>
                            <td>${p.brand} ${p.model}</td>
                            <td><span class="badge bg-dark">${count} fotos</span></td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-primary me-1" onclick="editProduct(${p.id})">‚úèÔ∏è</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>
                            </td>
                        </tr>`;
          });
        } catch (e) {
          console.error("Error al cargar datos", e);
        }
      }

      // --- CATEGOR√çAS CRUD ---
      // --- CRUD CATEGOR√çAS ---

      async function createCategory() {
        const name = document.getElementById("cat-name").value;
        if (!name) return;

        const res = await fetch(`${API_URL}/categories`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ name }),
        });

        if (res.ok) {
          document.getElementById("cat-name").value = "";
          loadData();
        } else {
          Swal.fire("Error", "No se pudo crear la categor√≠a", "error");
        }
      }

      async function editCategory(id, currentName) {
        const { value: newName } = await Swal.fire({
          title: "Editar Categor√≠a",
          input: "text",
          inputValue: currentName,
          showCancelButton: true,
          confirmButtonText: "Guardar",
          cancelButtonText: "Cancelar",
          inputValidator: (value) => {
            if (!value) return "¬°Debes escribir un nombre!";
          },
        });

        if (newName && newName !== currentName) {
          const res = await fetch(`${API_URL}/categories/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ name: newName }),
          });

          if (res.ok) {
            Swal.fire("Actualizado", "", "success");
            loadData();
          } else {
            Swal.fire("Error", "No se pudo actualizar", "error");
          }
        }
      }

      async function deleteCategory(id) {
        const result = await Swal.fire({
          title: "¬øBorrar categor√≠a?",
          text: "Esta acci√≥n no se puede deshacer.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          confirmButtonText: "S√≠, borrar",
        });

        if (result.isConfirmed) {
          const res = await fetch(`${API_URL}/categories/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });

          if (res.ok) {
            Swal.fire("Eliminado", "La categor√≠a ha sido borrada", "success");
            loadData();
          } else {
            const err = await res.json();
            Swal.fire(
              "Error",
              err.error || "No se puede borrar una categor√≠a con productos.",
              "error",
            );
          }
        }
      }

      // --- PRODUCTOS CRUD ---
      async function editProduct(id) {
        const res = await fetch(`${API_URL}/products/${id}`);
        const p = await res.json();
        document.getElementById("p-id").value = p.id;
        document.getElementById("p-PLATE").value = p.PLATE;
        document.getElementById("p-brand").value = p.brand;
        document.getElementById("p-model").value = p.model;
        document.getElementById("p-price").value = p.price;
        document.getElementById("p-year").value = p.year;
        document.getElementById("p-mileage").value = p.mileage;
        document.getElementById("p-category").value = p.categoryId;

        editingId = id;
        document.getElementById("is-editing").value = "true";
        document.getElementById("form-title").innerText =
          "üíæ Editando ID: " + id;
        document.getElementById("btn-submit").innerText = "Guardar Cambios";
        document.getElementById("btn-cancel-edit").classList.remove("hidden");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function resetForm() {
        editingId = null;
        document.getElementById("prod-form").reset();
        document.getElementById("is-editing").value = "false";
        document.getElementById("form-title").innerText =
          "üìù Ficha de Veh√≠culo";
        document.getElementById("btn-submit").innerText = "üöÄ Publicar Ahora";
        document.getElementById("btn-cancel-edit").classList.add("hidden");
      }

      document
        .getElementById("prod-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const isEditing =
            document.getElementById("is-editing").value === "true";
          const formData = new FormData();

          formData.append("PLATE", document.getElementById("p-PLATE").value);
          formData.append("brand", document.getElementById("p-brand").value);
          formData.append("model", document.getElementById("p-model").value);
          formData.append("price", document.getElementById("p-price").value);
          formData.append("year", document.getElementById("p-year").value);
          formData.append(
            "mileage",
            document.getElementById("p-mileage").value,
          );
          formData.append(
            "categoryId",
            document.getElementById("p-category").value,
          );
          formData.append(
            "publishedDate",
            new Date().toLocaleDateString("es-CL"),
          );

          const fileInput = document.getElementById("p-files");
          for (let f of fileInput.files) {
            formData.append("photos", f);
          }

          const url = isEditing
            ? `${API_URL}/products/${editingId}`
            : `${API_URL}/products`;
          const res = await fetch(url, {
            method: isEditing ? "PUT" : "POST",
            headers: { Authorization: `Bearer ${token}` },
            body: formData,
          });

          if (res.ok) {
            Swal.fire("√âxito", "Cat√°logo actualizado", "success");
            resetForm();
            loadData();
          } else {
            Swal.fire("Error", "No se pudo guardar", "error");
          }
        });

      async function deleteProduct(id) {
        const result = await Swal.fire({
          title: "¬øBorrar veh√≠culo?",
          icon: "warning",
          showCancelButton: true,
        });
        if (result.isConfirmed) {
          await fetch(`${API_URL}/products/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` },
          });
          loadData();
        }
      }

      checkAuth();
    </script>
  </body>
</html>
